<!DOCTYPE html>
<html>
<head>
    <title>Math & Code Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/mode/python/python.min.js"></script>
    <style>
        :root {
            --primary-color: #2b303b;
            --secondary-color: #1a1d24;
            --accent-color: #00bcd4;
            --text-color: #ffffff;
            --code-bg: #1e222a;
        }

        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .toolbar {
            background-color: var(--secondary-color);
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.8;
        }

        #editor {
            background-color: var(--secondary-color);
            min-height: calc(100vh - 120px);
            padding: 2rem;
            margin: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            caret-color: white;
            font-size: 16px;
        }

        .mq-editable-field {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
            margin: 0.2rem;
        }

        .code-block {
            background: var(--code-bg);
            border-radius: 6px;
            margin: 1rem 0;
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .code-output {
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .CodeMirror {
            height: auto;
            background: var(--code-bg);
            color: var(--text-color);
            border-radius: 0 0 6px 6px;
            font-family: 'Fira Code', monospace;
            padding-left: 50px !important;
        }

        .CodeMirror-gutters {
            background: var(--code-bg) !important;
            border-right: 1px solid rgba(255,255,255,0.1) !important;
            width: 45px !important;
        }

        .CodeMirror-linenumber {
            color: rgba(255,255,255,0.5) !important;
            padding: 0 8px !important;
        }

        .text-line {
            min-height: 24px;
            padding: 2px 0;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .code-editor-container {
            position: relative;
            overflow: hidden;
        }

        .plot-block {
            margin: 1rem 0;
            background: var(--code-bg);
            border-radius: 6px;
            padding: 1rem;
        }
        .plot-image {
            max-width: 100%;
            height: auto;
        }
        .plot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <input type="text" id="documentTitle" placeholder="Enter title..." value="document" 
           style="width: 200px; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--accent-color);">
        <button onclick="addFormula()">Add Formula</button>
        <button onclick="addPlotBlock()">Add Plot</button>
        <button onclick="addText()">Insert Text</button>
        <button onclick="addCodeBlock()">Insert Code</button>
        <button onclick="downloadDocument()">Download</button>
        <input type="file" id="fileUpload" accept=".json" hidden>
        <button onclick="document.getElementById('fileUpload').click()">Upload</button>
        <div class="font-size-control">
            <label for="fontSizeRange">Text Size:</label>
            <input type="range" id="fontSizeRange" min="12" max="32" value="16" oninput="adjustFontSize(this.value)">
        </div>
    </div>
    <div id="editor" contenteditable="true"></div>
    <div id="errorToast" style="position:fixed;bottom:20px;right:20px;background:#ff4444;color:white;padding:16px;border-radius:4px;display:none;max-width:300px;box-shadow:0 2px 5px rgba(0,0,0,0.2)">
        <span id="errorMessage"></span>
        <button onclick="hideError()" style="background:none;border:none;color:white;float:right;cursor:pointer">âœ•</button>
    </div>

    <script>
        const MQ = MathQuill.getInterface(2);

        function adjustFontSize(value) {
            document.getElementById('editor').style.fontSize = value + 'px';
            document.querySelectorAll('.CodeMirror').forEach(cm => cm.CodeMirror.refresh());
        }

        function addText() {
            const editor = document.getElementById('editor');
            const textDiv = document.createElement('div');
            textDiv.className = 'text-line';
            editor.appendChild(textDiv);
            const range = document.createRange();
            const selection = window.getSelection();
            range.selectNodeContents(textDiv);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function addFormula() {
            const editor = document.getElementById('editor');
            const formulaDiv = document.createElement('div');
            const span = document.createElement('span');
            formulaDiv.appendChild(span);
            editor.appendChild(formulaDiv);
            const mq = MQ.MathField(span, {
                handlers: {
                    enter: (e) => {
                        evaluateFormula(mathField);
                    }
                }
            });
            mq.focus();
        }

        function addCodeBlock() {
            const editor = document.getElementById('editor');
            const codeBlock = document.createElement('div');
            codeBlock.className = 'code-block';
            
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = '<span>Python Code</span>';
            
            const runButton = document.createElement('button');
            runButton.textContent = 'Run';
            runButton.onclick = () => executeCode(codeBlock);
            header.appendChild(runButton);
            
            const editorContainer = document.createElement('div');
            editorContainer.className = 'code-editor-container';
            
            const codeMirror = CodeMirror(editorContainer, {
                lineNumbers: true,
                mode: 'python',
                theme: 'default',
                lineWrapping: true,
                viewportMargin: Infinity,
                gutters: ['CodeMirror-linenumbers'],
                extraKeys: {'Ctrl-Enter': () => executeCode(codeBlock)}
            });
            
            const outputDiv = document.createElement('div');
            outputDiv.className = 'code-output';
            
            codeBlock.appendChild(header);
            codeBlock.appendChild(editorContainer);
            codeBlock.appendChild(outputDiv);
            editor.appendChild(codeBlock);
            
            setTimeout(() => codeMirror.refresh(), 0);
            codeMirror.focus();
        }

        function executeCode(codeBlock) {
            const codeMirror = codeBlock.querySelector('.CodeMirror').CodeMirror;
            const outputDiv = codeBlock.querySelector('.code-output');
            const code = codeMirror.getValue();
            
            fetch('/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                outputDiv.textContent = data.error ? data.error : data.output;
                outputDiv.style.color = data.error ? '#ff5555' : '#50fa7b';
                codeMirror.focus();
            });
        }

        function downloadDocument() {
            const title = document.getElementById('documentTitle').value;
            const content = [];
            $('#editor').children().each(function() {
                const element = $(this);
                let item = null;
                
                if (element.find('.mq-editable-field').length > 0) {
                    item = {
                        type: 'math',
                        latex: MQ(element.find('.mq-editable-field')[0]).latex()
                    };
                } else if (element.hasClass('code-block')) {
                    item = {
                        type: 'code',
                        code: element.find('.CodeMirror')[0].CodeMirror.getValue(),
                        output: element.find('.code-output').text()
                    };
                } else if (element.hasClass('plot-block')){
                    item = {
                        type: 'plot',
                        latex: element.querySelector('input').value,
                        image: element.querySelector('.plot-image')?.src
                    };
                } else {
                    item = {
                        type: 'text',
                        content: element.text()
                    };
                }
                content.push(item);
            });

            fetch('/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: title, 
                    content: content
                })
            })
            .then(response => {
                const filename = response.headers.get('Content-Disposition')
                    ?.split('filename=')[1]?.replace(/"/g, '') || 'document.json';
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }

        function uploadDocument(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                document.getElementById('documentTitle').value = data.title || 'document';
                const editor = document.getElementById('editor');
                editor.innerHTML = '';
                
                content.forEach(item => {
                    if (item.type === 'math') {
                        const div = document.createElement('div');
                        const span = document.createElement('span');
                        div.appendChild(span);
                        editor.appendChild(div);
                        MQ.MathField(span).latex(item.latex);
                    } else if (item.type === 'code') {
                        const codeBlock = document.createElement('div');
                        codeBlock.className = 'code-block';
                        
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = '<span>Python Code</span>';
                        
                        const runButton = document.createElement('button');
                        runButton.textContent = 'Run';
                        runButton.onclick = () => executeCode(codeBlock);
                        header.appendChild(runButton);
                        
                        const editorContainer = document.createElement('div');
                        editorContainer.className = 'code-editor-container';
                        
                        const codeMirror = CodeMirror(editorContainer, {
                            lineNumbers: true,
                            mode: 'python',
                            theme: 'default',
                            value: item.code,
                            lineWrapping: true,
                            viewportMargin: Infinity
                        });
                        
                        const outputDiv = document.createElement('div');
                        outputDiv.className = 'code-output';
                        outputDiv.textContent = item.output;
                        
                        codeBlock.appendChild(header);
                        codeBlock.appendChild(editorContainer);
                        codeBlock.appendChild(outputDiv);
                        editor.appendChild(codeBlock);
                    } else if (item.type === 'plot') {
                        const plotBlock = document.createElement('div');
                        plotBlock.className = 'plot-block';
                        
                        const header = document.createElement('div');
                        header.className = 'plot-header';
                        
                        const latexInput = document.createElement('input');
                        latexInput.type = 'text';
                        latexInput.placeholder = 'Enter function (e.g., x^2)';
                        latexInput.style.flexGrow = '1';
                        latexInput.style.marginRight = '1rem';
                        latexInput.value = item.latex || '';
                        
                        const plotButton = document.createElement('button');
                        plotButton.textContent = 'Generate Plot';
                        plotButton.onclick = () => generatePlot(plotBlock);
                        
                        const imageContainer = document.createElement('div');
                        imageContainer.className = 'plot-image-container';
                        
                        if (item.image) {
                            const img = document.createElement('img');
                            img.className = 'plot-image';
                            img.src = item.image;
                            imageContainer.appendChild(img);
                        }
                        
                        header.appendChild(latexInput);
                        header.appendChild(plotButton);
                        plotBlock.appendChild(header);
                        plotBlock.appendChild(imageContainer);
                        editor.appendChild(plotBlock);
                    } else {
                        const textDiv = document.createElement('div');
                        textDiv.className = 'text-line';
                        textDiv.textContent = item.content;
                        editor.appendChild(textDiv);
                    }
                });
                
                setTimeout(() => {
                    document.querySelectorAll('.CodeMirror').forEach(cm => {
                        cm.CodeMirror.refresh();
                        cm.CodeMirror.focus();
                    });
                }, 100);
            };
            reader.readAsText(file);
        }

        function evaluateFormula(mq) {
            const originalLatex = mq.latex();
            if (!originalLatex) {
                showError('Formula is empty');
                return;
            }
            let expression = originalLatex;
            if (!originalLatex.includes('=')) {
                expression += '=';
            }

            fetch('/evaluate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ latex: expression })
            })
            .then(response => {
                if (!response.ok) throw new Error('Server error');
                else response.json();
            })
            .then(data => {
                if (data.result) {
                    mq.latex(`${expression} \\boxed{${data.result}}`);
                } else {
                    showError(data.error || 'Evaluation failed');
                }
            })
            .catch(error => {
                showError(error.message || 'Invalid mathematical expression');
            });
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            document.getElementById('errorMessage').textContent = message;
            toast.style.display = 'block';
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorToast').style.display = 'none';
        }

        function addPlotBlock() {
            const editor = document.getElementById('editor');
            const plotBlock = document.createElement('div');
            plotBlock.className = 'plot-block';
            
            const header = document.createElement('div');
            header.className = 'plot-header';
            
            const latexInput = document.createElement('input');
            latexInput.type = 'text';
            latexInput.placeholder = 'Enter function (e.g., x^2)';
            latexInput.style.flexGrow = '1';
            latexInput.style.marginRight = '1rem';
            
            const plotButton = document.createElement('button');
            plotButton.textContent = 'Generate Plot';
            plotButton.onclick = () => generatePlot(plotBlock);
            
            header.appendChild(latexInput);
            header.appendChild(plotButton);
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'plot-image-container';
            
            plotBlock.appendChild(header);
            plotBlock.appendChild(imageContainer);
            editor.appendChild(plotBlock);
        }

        function generatePlot(plotBlock) {
            const latex = plotBlock.querySelector('input').value;
            const imageContainer = plotBlock.querySelector('.plot-image-container');
            
            fetch('/plot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ latex: latex })
            })
            .then(response => response.json())
            .then(data => {
                if (data.image) {
                    imageContainer.innerHTML = `<img src="data:image/png;base64,${data.image}" class="plot-image">`;
                } else {
                    showError(data.error || 'Failed to generate plot');
                }
            })
            .catch(error => showError('Plot generation failed'));
        }
    </script>
</body>
</html>